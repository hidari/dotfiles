# ストレージバックアップスクリプト

macOS 用の外部ストレージバックアップスクリプトです。rsync を使用して、指定したストレージ間で効率的な同期バックアップを行います。

## 特徴

- rsync の `--delete` オプションにより、バックアップ元と先を同期
- バックアップの履歴をログファイルとして保存し、古いログは自動削除
- Mac システムファイル除外: `.DS_Store` や `._*` などの不要なファイルを自動除外
- エラーハンドリング: マウント確認、容量チェック、終了ステータスの検証
- Dry-run モード: 実際にコピーせずに動作を確認可能

## 必要要件

- macOS: Catalina 10.15 以降を推奨
- bc: 容量計算用、macOS にデフォルトで付属
- rsync: Homebrew版（macOSデフォルトの v2.6.9 は `--delete` オプションと特殊なディレクトリ（`.Spotlight-V100`など）の組み合わせでクラッシュする既知のバグがある）

Homebrewでのインストールには以下のコマンドを実行します：

```bash
brew install rsync
# インストール後、必要に応じてパスの追加
```

## セットアップ

### 1. スクリプトを PATH の通った場所に配置

`~/.local/bin` にシンボリックリンクを作成します。これにより、どこからでも `backup.sh` で実行できるようになります：

```bash
mkdir -p ~/.local/bin
ln -sf ~/dotfiles/scripts/backup-tool/backup.sh ~/.local/bin/backup.sh
```

**注意**: `~/.local/bin` が PATH に含まれている必要があります。`.zshrc` に以下のような設定があることを確認してください：

```bash
path=(
    $HOME/.local/bin(N-/)
    # ...
)
```

### 2. 設定ファイルの作成

テンプレートをコピーして、自分用の設定ファイルを作成します：

```bash
cd ~/dotfiles/scripts/backup-tool  # スクリプトがあるディレクトリに移動
cp backup.example.conf backup.conf
```

### 3. 設定ファイルの編集

`backup.conf` をエディタで開き、自分の環境に合わせて編集します：

```bash
vim backup.conf  # または nano, code などお好みのエディタで
```

編集する項目：

- `BACKUP_PAIRS`: バックアップペアの配列（形式: `"名前|ソース|デスティネーション"`）
- `MINIMUM_FREE_SPACE_GB`: 最低限必要な空き容量（GB単位）
- `LOG_RETENTION_DAYS`: ログファイルの保持期間（日数）
- `LOG_BASE_DIR`: ログ保存先（オプション、未指定時は最初のソース配下）

設定例：

```bash
BACKUP_PAIRS=(
    "メインSSD|/Volumes/Luna-P|/Volumes/Luna-S"
)
```

**重要**: macOS では外部ドライブは `/Volumes/ドライブ名` にマウントされます。Finder でドライブ名を確認してください。

容量チェックについて: rsync は差分バックアップを行うため、2回目以降のバックアップでは変更されたファイルのみがコピーされます。
そのため、`MINIMUM_FREE_SPACE_GB` は初回のバックアップ元全体のサイズではなく、通常の差分バックアップで必要な容量を基準に設定してください（推奨: 100GB）。

## 使い方

### 基本的な実行

```bash
./backup.sh
```

実行すると、設定内容の確認画面が表示されます。内容を確認して `y` を入力すると、バックアップが開始されます。

### Dry-run モード（事前確認）

実際にコピーせずに、何が起きるかだけを確認できます：

```bash
./backup.sh --dry-run
```

または

```bash
./backup.sh -n
```

初めて使う場合や、`--delete` オプションの影響が気になる場合は、まず dry-run で確認することを強く推奨します。

## 除外されるファイル

以下のファイルやディレクトリは自動的にバックアップから除外されます：

### macOS システムファイル
- `.DS_Store`: Finder の表示設定
- `._*`: AppleDouble ファイル（リソースフォーク）
- `.Spotlight-V100`: Spotlight インデックス
- `.Trashes`: ゴミ箱
- `.fseventsd`: ファイルシステムイベント
- その他多数の macOS 特有のファイル

### Windows システムファイル
- `Thumbs.db`: Windows のサムネイルキャッシュ
- `desktop.ini`: Windows のフォルダ設定

詳細はスクリプト内の除外リストを参照してください。

## ログファイル

バックアップの実行履歴は、デフォルトでは最初のバックアップペアのソースパス配下の `.backup_logs` ディレクトリに保存されます。
`LOG_BASE_DIR` を設定することで、任意の場所に変更できます。

```
/Volumes/バックアップ元/.backup_logs/
  ├── backup_20251031_143000.log
  ├── backup_20251101_093000.log
  └── ...
```

ログファイルには以下の情報が記録されます：

- バックアップの開始・終了時刻
- マウントポイントの確認結果
- ディスク容量チェックの結果
- rsync の詳細な出力（どのファイルがコピーされたか）
- エラーメッセージ（発生した場合）
- 所要時間

古いログファイルは、設定で指定した日数（デフォルト90日）より古いものが自動的に削除されます。

## トラブルシューティング

### 設定ファイルが見つかりません

`backup.conf` が存在しない場合に表示されます。セットアップ手順に従って、設定ファイルを作成してください。

### マウントされていません

指定したストレージがマウントされていない、または名前が間違っている可能性があります。

確認方法：

```bash
ls /Volumes/
```

Finder でドライブ名を確認し、`backup.conf` の設定を修正してください。

### 空き容量が不足しています

バックアップ先の空き容量が、設定ファイルの `MINIMUM_FREE_SPACE_GB` で指定した値より少ない場合に表示されます。

対処方法：

1. バックアップ先から古いバックアップや不要なファイルを削除して、空き容量を増やす
2. 通常の差分バックアップで十分な場合は、`MINIMUM_FREE_SPACE_GB` の値を小さくする（ただし、最低でも50GB程度は推奨）
3. 根本的な解決として、より大きな容量のストレージに変更する

**注意**: 初回バックアップの場合は、バックアップ元全体のサイズ分の空き容量が必要です。2回目以降は差分のみがコピーされるため、必要な容量は大幅に少なくなります。

### Operation not permitted

スクリプト実行中に `.Spotlight-V100` や `.Trashes` へのアクセス拒否エラーが表示されることがありますが、これはmacOSのシステム保護機能による正常な動作です。スクリプトの実行には影響しません。エラー出力は自動的に抑制されるため、通常は表示されません。

### バックアップが完了しました（警告あり）

バックアップ完了時に警告が表示されることがありますが、これは**正常な動作**です。

原因: macOSが保護しているシステムディレクトリ（`.Trashes`、`.Spotlight-V100`など）の削除で問題が発生した場合に表示されます。rsyncが「バックアップ元にないファイル」として削除しようとしますが、これらはシステムが特殊な権限で保護しているため削除できません。

影響: ありません。重要なデータ（写真、イラスト、ドキュメントなど）は全て正しくバックアップされています。削除できなかったのはmacOSが自動生成する空のシステムディレクトリだけです。

対処: 特に対処は不要です。このメッセージは無視しても問題ありません。気になる場合は、ログファイルで詳細を確認できます。

### 日本語ファイル名が文字化けする

スクリプトにロケール設定が含まれているため、通常は問題ありませんが、もし文字化けする場合は以下を確認してください：

```bash
locale  # ロケール設定を確認
```

`ja_JP.UTF-8` が利用可能か確認し、利用できない場合は `en_US.UTF-8` でも動作します。

## 注意事項

- このスクリプトは `rsync` の `--delete` オプションを使用しています。これは、バックアップ元に存在しないファイルをバックアップ先から削除する機能です。初めて使う場合は、必ず dry-run モードで動作を確認してください。
- バックアップ元とバックアップ先の設定を間違えると、データが削除される可能性があります。設定ファイルを慎重に確認してください。
- このスクリプトを cron や launchd で定期実行する場合は、ログファイルを定期的に確認することを推奨します。

## カスタマイズ

### 除外パターンの追加

スクリプトには基本的な除外リスト（`.DS_Store`、`._*`、`.Spotlight-V100` など）があらかじめ組み込まれています。
通常はこのままで問題ありませんが、特定のファイルやディレクトリを追加で除外したい場合は、設定ファイルで追加の除外パターンを指定できます。

#### 設定方法

`backup.conf` を開き、`ADDITIONAL_EXCLUDE` 配列を定義します：

```bash
# 追加の除外パターン
ADDITIONAL_EXCLUDE=(
    "node_modules"      # Node.jsの依存パッケージ
    ".venv"             # Pythonの仮想環境
    "*.log"             # すべてのログファイル
)
```

#### 注意事項

- ワイルドカード（`*` や `?`）を使用できます
- ディレクトリを除外する場合、末尾に `/` を付けると明示的です
- 除外パターンは慎重に設定してください（誤って重要なファイルを除外しないよう注意）
- 基本的な除外リストは常に適用されます（上書きではなく追加です）

### 最低限必要な空き容量の変更

`backup.conf` の `MINIMUM_FREE_SPACE_GB` を変更することで、バックアップ実行前にチェックする最低限の空き容量を調整できます。

- 大量の写真やイラストを頻繁に追加する場合: 200GB
- 一般的な使用: 100GB（デフォルト）
- 小規模な変更のみの場合: 50GB

**注意**: 初回バックアップでは、バックアップ元全体のサイズ分の空き容量が必要です。

### ログ保持期間の変更

`backup.conf` の `LOG_RETENTION_DAYS` を変更することで、ログの保持期間を調整できます。

## 参考

- [rsync マニュアル](https://ss64.com/osx/rsync.html)
- [macOS でのバックアップベストプラクティス](https://support.apple.com/ja-jp/HT201250)
